<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Kehadiran Karyawan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --bg-light: #f8fafc;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-light); color: #334155; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .dashboard-header { background: var(--primary); color: white; padding: 25px 20px; border-radius: 0 0 25px 25px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .attendance-item { background: white; margin-bottom: 10px; padding: 15px; border-radius: 12px; border-left: 5px solid #cbd5e1; }
        .status-masuk { border-left-color: #22c55e; }
        .status-libur { border-left-color: #94a3b8; }
        .status-cuti { border-left-color: #f59e0b; }
        .time-badge { font-size: 0.85rem; font-weight: 600; padding: 4px 8px; background: #f1f5f9; border-radius: 6px; }
        #dashboard { display: none; }
    </style>
</head>
<body>

<div id="login-page" class="login-container">
    <div class="card p-4 w-100" style="max-width: 400px;">
        <div class="text-center mb-4">
            <i class="fas fa-user-clock fa-3x text-primary mb-3"></i>
            <h4 class="fw-bold">Masuk Portal</h4>
            <p class="text-muted small">Gunakan Token Karyawan Anda</p>
        </div>
        <div class="mb-3">
            <input type="text" id="tokenInput" class="form-control form-control-lg text-center" placeholder="Masukkan Token">
        </div>
        <button onclick="handleLogin()" class="btn btn-primary w-100 btn-lg shadow-sm">Buka Data</button>
        <div id="loginError" class="text-danger small text-center mt-3" style="display:none;">Token tidak terdaftar!</div>
    </div>
</div>

<div id="dashboard">
    <div class="dashboard-header d-flex justify-content-between align-items-center">
        <div>
            <h5 id="userName" class="mb-0 fw-bold">-</h5>
            <small id="userJob" class="opacity-75">-</small>
        </div>
        <button onclick="logout()" class="btn btn-sm btn-light rounded-circle"><i class="fas fa-sign-out-alt text-primary"></i></button>
    </div>

    <div class="container mb-4">
        <div class="row g-2">
            <div class="col-4">
                <div class="stat-card">
                    <div class="stat-value" id="statHadir">0</div>
                    <div class="stat-label">Hadir</div>
                </div>
            </div>
            <div class="col-4">
                <div class="stat-card">
                    <div class="stat-value text-warning" id="statLembur">0</div>
                    <div class="stat-label">Lembur</div>
                </div>
            </div>
            <div class="col-4">
                <div class="stat-card">
                    <div class="stat-value text-success" id="statCuti">0</div>
                    <div class="stat-label">Sisa Cuti</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <h6 class="fw-bold mb-3">Riwayat Kehadiran (Jan 2026)</h6>
        <div id="attendanceList">
            </div>
    </div>
</div>

<script>
    let employees = [];
    let attendance = [];

    // Mengambil data dari file eksternal
    async function loadData() {
        try {
            const [empRes, attRes] = await Promise.all([
                fetch('employees.json'),
                fetch('currentkehadiran.json')
            ]);
            employees = await empRes.json();
            attendance = await attRes.json();
        } catch (error) {
            console.error("Gagal memuat data:", error);
            alert("Gagal memuat file JSON. Pastikan file ada di folder yang sama.");
        }
    }

    // Konversi desimal Excel ke Jam:Menit (misal 0.3125 -> 07:30)
    function formatExcelTime(val) {
        if (val === "-" || !val) return "-";
        const totalMinutes = Math.round(parseFloat(val) * 24 * 60);
        const hours = Math.floor(totalMinutes / 60);
        const mins = totalMinutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    function handleLogin() {
        const token = document.getElementById('tokenInput').value;
        const user = employees.find(e => e.token === token);

        if (user) {
            showDashboard(user);
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function showDashboard(user) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        document.getElementById('userName').innerText = user.nama;
        document.getElementById('userJob').innerText = `${user.jabatan} - ${user.bagian}`;

        const userAtt = attendance.filter(a => a.token === user.token);
        renderStats(user, userAtt);
        renderAttendance(userAtt);
    }

    function renderStats(user, userAtt) {
        const totalHadir = userAtt.filter(a => a.keterangan === "Masuk").length;
        const totalLembur = userAtt.reduce((sum, item) => sum + (parseFloat(item[" SPL "]) || 0), 0);
        
        document.getElementById('statHadir').innerText = totalHadir;
        document.getElementById('statLembur').innerText = totalLembur;
        document.getElementById('statCuti').innerText = user["initial Cuti"] || 0;
    }

    function renderAttendance(data) {
        const container = document.getElementById('attendanceList');
        container.innerHTML = '';

        data.forEach(item => {
            const statusClass = item.keterangan === 'Masuk' ? 'status-masuk' : (item.keterangan === 'Cuti' ? 'status-cuti' : 'status-libur');
            const html = `
                <div class="attendance-item ${statusClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold">${item.tanggal}</div>
                            <small class="text-muted">${item.keterangan}</small>
                        </div>
                        <div class="text-end">
                            <div class="time-badge mb-1">
                                <i class="far fa-clock me-1"></i> ${formatExcelTime(item.masuk)} - ${formatExcelTime(item.pulang)}
                            </div>
                            ${item[" SPL "] > 0 ? `<span class="badge bg-warning text-dark">OT: ${item[" SPL "]}h</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function logout() {
        location.reload();
    }

    // Inisialisasi data saat halaman dibuka
    loadData();
</script>

</body>
</html>